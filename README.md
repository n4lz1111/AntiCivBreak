# New AntiCivBreak
ANNI向けのCivBreak対策プラグイン
> [!CAUTION]
> 動作には前提プラグイン`PacketEvents`の導入が必要です。
## モジュール
### `ConsistencyRayTrace`
プレイヤーの視点から破壊されたブロックに対してレイトレーシングを行い、本来破壊ができない場所からの破壊（壁越しの破壊など）をキャンセルします。
### `BreakingTimeSimulation`
プレイヤーの持っているピッケルの性能や、プレイヤーの行動、周りの環境を考慮しながらネクサスの破壊時間を再計算し、時間をシミュレーション（予測）します。予測された時間と実際に破壊にかかった時間を比べ、異常があれば破壊をキャンセルします。
### `DestructionRangeLimitation`
プレイヤーの視点位置から最短となるブロックの表面のある一点との距離が、通常のクライアントで破壊できるリーチを超えた破壊をキャンセルします。レイトレーシングの計算量を削減する目的もあります。
### `InvalidPacket`
通常クライアントがブロックを破壊に関して送るパケットは、特定のパターンに限られます。それ以外のパターンのパケットは受け取りをキャンセルします。
ただし通常プレイに支障が出てしまうため、[MC-69865](https://bugs.mojang.com/browse/MC/issues/MC-69865)の影響は考慮しています。
## CivBreakとは？
### `ブロック破壊の仕組み`
マインクラフトでブロックを破壊するには、主に3つの「パケット」をクライアントがサーバーに送信します。
#### START_DIGGING
クライアントが特定のブロックの破壊を開始したときに送信パケットです。
#### FINISHED_DIGGING
クライアントが特定のブロックを破壊し終えたときに送信されるパケットです。
#### CANCELLED_DIGGING
クライアントが特定のブロックの破壊を開始したものの、視点がズレるなどして破壊がキャンセルされたときに送信されるパケットです。
### `CivBreakの仕組み`
サーバー側は、プレイヤーから「破壊を始めた」「破壊が終わった」という開始と終了だけを受け取ります。しかし改造されたクライアントでは、開始のパケットを送り、破壊がまだ終わっていないのにも関わらず終了のパケットを即座に送ることで、サーバー側は特定のブロックを破壊し終えたと勘違いし、破壊の処理を行います。これを繰り返し高速で行うことでネクサスが異常なスピードで破壊されてしまいます。
### 原因
これらはマインクラフトの仕様上致し方なく、ブロック破壊においてサーバーは、クライアントから送られてくる情報をそのまま信じて処理しています。
### 対策
サーバーは検出してくれないため、このAntiCivBreakプラグインは、送られてきた情報を元にそれが「本当に可能なのか」をリアルタイムで検証・シミュレーションを行い、不正だと判断されればキャンセルします。
