# New AntiCivBreak
ANNI向けのCivBreak対策プラグイン
> [!CAUTION]
> 動作には前提プラグイン`PacketEvents`の導入が必要です。
## モジュール
### `ConsistencyRayTrace`
プレイヤーの視点から破壊されたブロックに対してレイトレーシングを行い、本来破壊ができない場所からの破壊（壁越しの破壊など）をキャンセルします。
### `BreakingTimeSimulation`
プレイヤーの持っているピッケルの性能や、プレイヤーの行動、周りの環境を考慮しながらネクサスの破壊時間を再計算し、時間をシミュレーション（予測）します。予測された時間と実際に破壊にかかった時間を比べ、異常があれば破壊をキャンセルします。
### `FinishedPacketSimulation`
BreakingTimeSimulationの似たもの同士です。実際に破壊されるプロセスに従ってシミュレーションを行うのではなく、あえて限定されたパケットのみでシミュレーションを行います。
### `SimulationResultAnalysis`
シミュレーション結果を信頼度に基づいて統計的に評価します。統計的な計算により即時検出はできませんが、より小さな傾向に基づいた検出が可能です。
### `DestructionRangeLimitation`
プレイヤーの視点位置から最短となるブロックの表面のある一点との距離が、通常のクライアントで破壊できるリーチを超えた破壊をキャンセルします。レイトレーシングの計算量を削減する目的もあります。
### `InvalidPacket`
CivBreakBypassのためのパケットをcancelします
## CivBreakとは？
### `ブロック破壊の仕組み`
マインクラフトでブロックを破壊するには、主に3つの「パケット」をクライアントがサーバーに送信します。
#### START_DIGGING
クライアントが特定のブロックの破壊を開始したときに送信パケットです。
#### FINISHED_DIGGING
クライアントが特定のブロックを破壊し終えたときに送信されるパケットです。
#### CANCELLED_DIGGING
クライアントが特定のブロックの破壊を開始したものの、視点がズレたり途中でやめるなどして破壊がキャンセルされたときに送信されるパケットです。
### `CivBreakの仕組み`
サーバーは通常、プレイヤーから送信されるブロック破壊操作をもとに、採掘の進捗（破壊進行度）を内部的に蓄積し、その進捗が一定値に達した後破壊完了が送信されるとブロックを破壊したと判断します。
CivBreak では、最初に通常のブロック破壊操作を行い、サーバー側に採掘進捗を最大まで蓄積させます。その状態で破壊完了を示すアクションを送信すると、サーバー側は採掘が正当に完了したものと誤認し、ブロックの破壊処理を実行してしまいます。
このため、破壊開始と破壊完了を同時に送信しただけでは破壊は成立しません。あらかじめサーバー側に採掘進捗が存在していることが、この挙動が成立する前提条件となります。
この誤認を利用して破壊完了処理を短時間に繰り返し発生させることで、ネクサスなどの特殊な耐久処理を持つブロックが、本来想定されていない速度で破壊されてしまいます。
### 原因
これらはマインクラフトの仕様上致し方なく、ブロック破壊においてサーバーは、クライアントから送られてくる情報をそのまま信じて処理しています。
### 対策
サーバーは検出してくれないため、このAntiCivBreakプラグインは、送られてきた情報を元にそれが「本当に可能なのか」をリアルタイムで検証・シミュレーションを行い、不正だと判断されればキャンセルします。
